# name: inference/operators.test
# description: A basic test for each of the 4 inference operator types
# groups: [Inference]

GlobalConfiguration worker.default_query_execution.operator_buffer_size: [30000]

CREATE LOGICAL SOURCE streamFloat32(f1 FLOAT32, f2 FLOAT32, f3 FLOAT32, f4 FLOAT32);
CREATE PHYSICAL SOURCE FOR streamFloat32 TYPE File;
ATTACH INLINE
1.0,10.0,100.0,1000.0
2.0,20.0,200.0,2000.0
1.0,10.0,100.0,1000.0
3.0,30.0,300.0,3000.0
2.0,20.0,200.0,2000.0
4.0,40.0,400.0,4000.0
5.0,50.0,500.0,5000.0
4.0,40.0,400.0,4000.0
6.0,60.0,600.0,6000.0
5.0,50.0,500.0,5000.0
7.0,70.0,700.0,7000.0
8.0,80.0,800.0,8000.0
7.0,70.0,700.0,7000.0
9.0,90.0,900.0,9000.0
8.0,80.0,800.0,8000.0
10.0,100.0,1000.0,10000.0
11.0,110.0,1100.0,11000.0
10.0,100.0,1000.0,10000.0
12.0,120.0,1200.0,12000.0
11.0,110.0,1100.0,11000.0

CREATE SINK classificationThreeSeparate(p1 FLOAT32, p2 FLOAT32, p3 FLOAT32) TYPE File;

CREATE MODEL linearFloat32(
    PATH "TESTDATA/model/linear_f32.onnx"
    INPUTS (FLOAT32, FLOAT32, FLOAT32, FLOAT32)
    OUTPUTS (p1 FLOAT32, p2 FLOAT32, p3 FLOAT32)
);

# IREEInferenceOperator

SELECT p1, p2, p3
FROM (SELECT INFER_MODEL(linearFloat32, (f1, f2, f3, f4)) FROM streamFloat32)
INTO classificationThreeSeparate;
----
9630.0,10741.0,11852.0
19260.0,21482.0,23704.0
9630.0,10741.0,11852.0
28890.0,32223.0,35556.0
19260.0,21482.0,23704.0
38520.0,42964.0,47408.0
48150.0,53705.0,59260.0
38520.0,42964.0,47408.0
57780.0,64446.0,71112.0
48150.0,53705.0,59260.0
67410.0,75187.0,82964.0
77040.0,85928.0,94816.0
67410.0,75187.0,82964.0
86670.0,96669.0,106668.0
77040.0,85928.0,94816.0
96300.0,107410.0,118520.0
105930.0,118151.0,130372.0
96300.0,107410.0,118520.0
115560.0,128892.0,142224.0
105930.0,118151.0,130372.0

# IREECacheInferenceOperator
Configuration worker.default_query_execution.inference.prediction_cache_type: [FIFO]
Configuration worker.default_query_execution.inference.number_of_entries_prediction_cache: [3]

SELECT p1, p2, p3
FROM (SELECT INFER_MODEL(linearFloat32, (f1, f2, f3, f4)) FROM streamFloat32)
INTO classificationThreeSeparate;
----
9630.0,10741.0,11852.0
19260.0,21482.0,23704.0
9630.0,10741.0,11852.0
28890.0,32223.0,35556.0
19260.0,21482.0,23704.0
38520.0,42964.0,47408.0
48150.0,53705.0,59260.0
38520.0,42964.0,47408.0
57780.0,64446.0,71112.0
48150.0,53705.0,59260.0
67410.0,75187.0,82964.0
77040.0,85928.0,94816.0
67410.0,75187.0,82964.0
86670.0,96669.0,106668.0
77040.0,85928.0,94816.0
96300.0,107410.0,118520.0
105930.0,118151.0,130372.0
96300.0,107410.0,118520.0
115560.0,128892.0,142224.0
105930.0,118151.0,130372.0

# IREEBatchInferenceOperator
# Configuration worker.query_engine.number_of_worker_threads: [1]
Configuration worker.default_query_execution.inference.batch_size: [4]

SELECT p1, p2, p3
FROM (SELECT INFER_MODEL(linearFloat32, (f1, f2, f3, f4)) FROM streamFloat32)
INTO classificationThreeSeparate;
----
9630.0,10741.0,11852.0
19260.0,21482.0,23704.0
9630.0,10741.0,11852.0
28890.0,32223.0,35556.0
19260.0,21482.0,23704.0
38520.0,42964.0,47408.0
48150.0,53705.0,59260.0
38520.0,42964.0,47408.0
57780.0,64446.0,71112.0
48150.0,53705.0,59260.0
67410.0,75187.0,82964.0
77040.0,85928.0,94816.0
67410.0,75187.0,82964.0
86670.0,96669.0,106668.0
77040.0,85928.0,94816.0
96300.0,107410.0,118520.0
105930.0,118151.0,130372.0
96300.0,107410.0,118520.0
115560.0,128892.0,142224.0
105930.0,118151.0,130372.0

# IREEBatchCacheInferenceOperator
# Configuration worker.query_engine.number_of_worker_threads: [1]
Configuration worker.default_query_execution.inference.batch_size: [4]
Configuration worker.default_query_execution.inference.prediction_cache_type: [FIFO]
Configuration worker.default_query_execution.inference.number_of_entries_prediction_cache: [3]

SELECT p1, p2, p3
FROM (SELECT INFER_MODEL(linearFloat32, (f1, f2, f3, f4)) FROM streamFloat32)
INTO classificationThreeSeparate;
----
9630.0,10741.0,11852.0
19260.0,21482.0,23704.0
9630.0,10741.0,11852.0
28890.0,32223.0,35556.0
19260.0,21482.0,23704.0
38520.0,42964.0,47408.0
48150.0,53705.0,59260.0
38520.0,42964.0,47408.0
57780.0,64446.0,71112.0
48150.0,53705.0,59260.0
67410.0,75187.0,82964.0
77040.0,85928.0,94816.0
67410.0,75187.0,82964.0
86670.0,96669.0,106668.0
77040.0,85928.0,94816.0
96300.0,107410.0,118520.0
105930.0,118151.0,130372.0
96300.0,107410.0,118520.0
115560.0,128892.0,142224.0
105930.0,118151.0,130372.0


# Varsized data
CREATE LOGICAL SOURCE solarPowerSource(timestamp UINT64, value FLOAT32);
CREATE PHYSICAL SOURCE FOR solarPowerSource TYPE File;
ATTACH INLINE
1574897607000,94.1
1574897611000,94.1
1574897615000,93.2
1574897619000,93.2
1574897623000,92.1
1574897627000,92.1
1574897631000,92.1
1574897635000,94.5
1574897639000,94.5
1574897643000,93.2
1574897647000,93.2
1574897651000,93.2
1574897655000,94.5
1574897659000,94.5
1574897663000,93.0
1574897667000,93.0
1574897671000,93.0
1574897675000,97.6
1574897679000,97.6
1574897683000,96.1
1574897687000,96.1
1574897691000,96.1
1574897695000,96.1
1574897699000,96.1
1574897703000,94.6
1574897707000,94.6
1574897711000,94.6
1574897715000,95.7
1574897719000,95.7
1574897723000,95.7

CREATE SINK solarPowerVarsizedChecksum(powerProdNext8Sec VARSIZED) TYPE Checksum;

CREATE MODEL dLinear(
    PATH "TESTDATA/model/solar_power/pretrained/dlinear/dlinear_solar_size_60_stride_4.onnx"
    INPUTS (VARSIZED)
    OUTPUTS (powerProdNext8Sec VARSIZED)
);

# IREEInferenceOperator
SELECT powerProdNext8Sec FROM (
    SELECT INFER_MODEL(dLinear, (value_60_sec))
    FROM (
        SELECT ARRAY_AGG(value) AS value_60_sec
        FROM solarPowerSource
        WINDOW SLIDING(timestamp, SIZE 60000 ms, ADVANCE BY 4000 ms)
    )
) INTO solarPowerVarsizedChecksum;
----
44,4480

# IREECacheInferenceOperator
Configuration worker.default_query_execution.inference.prediction_cache_type: [FIFO]
Configuration worker.default_query_execution.inference.number_of_entries_prediction_cache: [3]

SELECT powerProdNext8Sec FROM (
    SELECT INFER_MODEL(dLinear, (value_60_sec))
    FROM (
        SELECT ARRAY_AGG(value) AS value_60_sec
        FROM solarPowerSource
        WINDOW SLIDING(timestamp, SIZE 60000 ms, ADVANCE BY 4000 ms)
    )
) INTO solarPowerVarsizedChecksum;
----
44,4480

# IREEBatchInferenceOperator
Configuration worker.query_engine.number_of_worker_threads: [1]
Configuration worker.default_query_execution.inference.batch_size: [2]

SELECT powerProdNext8Sec FROM (
    SELECT INFER_MODEL(dLinear, (value_60_sec))
    FROM (
        SELECT ARRAY_AGG(value) AS value_60_sec
        FROM solarPowerSource
        WINDOW SLIDING(timestamp, SIZE 60000 ms, ADVANCE BY 4000 ms)
    )
) INTO solarPowerVarsizedChecksum;
----
44,4480

# IREEBatchCacheInferenceOperator
Configuration worker.query_engine.number_of_worker_threads: [1]
Configuration worker.default_query_execution.inference.batch_size: [2]
Configuration worker.default_query_execution.inference.prediction_cache_type: [FIFO]
Configuration worker.default_query_execution.inference.number_of_entries_prediction_cache: [3]

SELECT powerProdNext8Sec FROM (
    SELECT INFER_MODEL(dLinear, (value_60_sec))
    FROM (
        SELECT ARRAY_AGG(value) AS value_60_sec
        FROM solarPowerSource
        WINDOW SLIDING(timestamp, SIZE 60000 ms, ADVANCE BY 4000 ms)
    )
) INTO solarPowerVarsizedChecksum;
----
44,3555
